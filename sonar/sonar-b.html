<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="css/main.css">
    <style type="text/css">
      
    </style>
  </head>
  <body>

    <div id="viz_container">
      <div id="viz"></div>
      <div id="legend"></div>
      
      <input id="data_updation_interval" type="text" value="1000">
      <button id="btn_data_updation_interval">Update</button>
      
    </div>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.4.3/d3.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="js/d3.sonar.js"></script>

    <script type="text/javascript">

      var sonar_el = document.querySelector("#viz");

      var colors = {
            indicator: "#aace00",
            heading: "#1A68DB"
          };

      var sonar_viz = d3.sonar()
                        .container_el(sonar_el)
                        .xDomain([-180,180])
                        .xTickValues([-180,-135,-90,-45,0,45,90,135,180])
                        .headingKeys({
                          x: 'degree',
                          y: 'date'
                        })
                        .detectionKeys({
                          x: 'degree',
                          y: 'date'
                        })
                        .colors(colors);

      var active_timers = [],
          data_updation_interval = 1000;  // in milliseconds

      // Returns a random integer between min and max
      // Using Math.round() will give you a non-uniform distribution!
      function getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
      }

      function setDataUpdateRoutine(argument) {
    
        active_timers.push( 
          setInterval(function(){
            addHeading( new Date(), getRandomInt(110,150) );
          }, data_updation_interval )
        );

        active_timers.push( 
          setInterval(function(){
            addDetection(new Date(), 'New Delhi', getRandomInt(110,120), getRandomInt(1,10)  );
          }, data_updation_interval )
        );

        active_timers.push(
          setInterval(function(){
            addDetection(new Date(), 'Bangalore', getRandomInt(140,150), getRandomInt(1,10)  );
          }, data_updation_interval)
        );

        active_timers.push( 
          setInterval(function(){
            addDetection(new Date(), 'Vadodara', getRandomInt(130,140), getRandomInt(1,10)  );
          }, data_updation_interval)
        );

      };

      function addHeading(time, bearing) {
    
        var data = {
            name: 'Heading',
            time: new Date(time),
            value: bearing
        };

        sonar_viz
          .purgeOldData(true)
          .addHeading(data);

      };

      function addDetection(time, seriesName, bearing, strength){
        
        var data = {
            name: seriesName,
            time: new Date(time),
            value: bearing,
            strength: strength
        };

        sonar_viz
          .purgeOldData(true)
          .addDetection(data);

      };

      $("#btn_data_updation_interval").on("click", function(e){
        // clear interval
        active_timers.forEach(function(t){
          clearInterval(t);
        });
        active_timers = [];
        data_updation_interval = +$("#data_updation_interval").val();
        setDataUpdateRoutine();
      });

      // begin
      sonar_viz();
      // update dataset
      setDataUpdateRoutine();

    </script>

  </body>
</html>